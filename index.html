<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Application</title>
    <link rel="stylesheet" href="style.css">
    <script>
        let hostMode = window.location.search.includes('host=true');
        let currentQuestionIndex = 0;
        let answers = {};  // 班番号ごとの回答
        let grades = {};   // 採点情報

        // 問題データ
        let questions = [
            { question: "What is the capital of France?", id: 1 },
            { question: "What is 2 + 2?", id: 2 },
        ];

        // 班番号の入力フォーム
        function promptForTeamNumber() {
            let teamNumber = sessionStorage.getItem("teamNumber");
            if (!teamNumber) {
                document.getElementById("team-number-form").style.display = "block";
                document.getElementById("quiz-container").style.display = "none";
            } else {
                document.getElementById("quiz-container").style.display = "block";
            }
        }

        // 班番号を保存
        function saveTeamNumber() {
            let teamNumber = document.getElementById("team-number").value;
            if (teamNumber) {
                sessionStorage.setItem("teamNumber", teamNumber);
                document.getElementById("team-number-form").style.display = "none";
                document.getElementById("quiz-container").style.display = "block";
                loadQuestion();
            } else {
                alert("Please enter a team number.");
            }
        }

        // ホストモードの切り替え
        function toggleHostMode() {
            hostMode = !hostMode;
            const url = new URL(window.location.href);
            if (hostMode) {
                url.searchParams.set('host', 'true');
            } else {
                url.searchParams.delete('host');
            }
            window.location.href = url.toString();
        }

        // 問題を読み込む
        function loadQuestion() {
            const questionContainer = document.getElementById("question");
            const answerContainer = document.getElementById("answer-container");
            const waitingMessage = document.getElementById("waiting-message");

            if (currentQuestionIndex < questions.length) {
                questionContainer.innerHTML = questions[currentQuestionIndex].question;
                answerContainer.style.display = hostMode ? 'none' : 'block';
                waitingMessage.style.display = 'none';
            } else {
                questionContainer.textContent = "Quiz completed!";
                answerContainer.style.display = 'none';
                waitingMessage.style.display = 'none';
                if (hostMode) {
                    displayResults();
                }
            }
        }

        // 回答を送信
        function submitAnswer() {
            const answer = document.getElementById("answer-input").value;
            const teamNumber = sessionStorage.getItem("teamNumber");

            if (!teamNumber) {
                alert("Team number is missing. Please refresh and enter your team number.");
                return;
            }

            if (!answer) {
                alert("Please enter an answer.");
                return;
            }

            answers[teamNumber] = answers[teamNumber] || [];
            answers[teamNumber].push({
                questionId: questions[currentQuestionIndex].id,
                answer: answer
            });

            document.getElementById("answer-input").value = "";
            document.getElementById("answer-container").style.display = 'none';
            document.getElementById("waiting-message").style.display = 'block';
        }

        // 次の問題に進む
        function allowNextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        // 結果を表示
        function displayResults() {
            const resultsContainer = document.getElementById("results");
            resultsContainer.innerHTML = "<h2>Results</h2>";
            for (const [teamNumber, teamAnswers] of Object.entries(answers)) {
                resultsContainer.innerHTML += `<p>Team ${teamNumber}:<br>${teamAnswers.map(a => `Q${a.questionId}: ${a.answer}`).join('<br>')}</p>`;
                if (hostMode) {
                    displayGradingOptions(teamNumber, teamAnswers);
                }
            }
        }

        // 採点オプションの表示
        function displayGradingOptions(teamNumber, teamAnswers) {
            const resultsContainer = document.getElementById("results");
            teamAnswers.forEach((answer, index) => {
                const gradeOptions = Array.from({ length: 5 }, (_, i) => {
                    return `<option value="${i + 1}" ${grades[teamNumber] && grades[teamNumber][index] === i + 1 ? 'selected' : ''}>${i + 1}</option>`;
                }).join('');
                resultsContainer.innerHTML += `
                    <div>
                        <label>Grade for Q${answer.questionId}:</label>
                        <select class="grade-dropdown" onchange="saveGrade('${teamNumber}', ${index}, this.value)">
                            ${gradeOptions}
                        </select>
                    </div>`;
            });
        }

        // 採点結果を保存
        function saveGrade(teamNumber, answerIndex, grade) {
            if (!grades[teamNumber]) grades[teamNumber] = [];
            grades[teamNumber][answerIndex] = parseInt(grade, 10);
        }

        // 最終結果を表示
        function calculateFinalResults() {
            const finalResults = [];
            for (const [teamNumber, teamAnswers] of Object.entries(answers)) {
                const totalScore = teamAnswers.reduce((sum, answer, index) => {
                    const grade = grades[teamNumber] && grades[teamNumber][index];
                    return sum + (grade || 0);
                }, 0);
                finalResults.push({ teamNumber, totalScore });
            }
            finalResults.sort((a, b) => b.totalScore - a.totalScore);
            displayFinalResults(finalResults);
        }

        // 最終結果を表示
        function displayFinalResults(finalResults) {
            const resultsContainer = document.getElementById("results");
            resultsContainer.innerHTML = "<h2>Final Results</h2>";
            finalResults.forEach(result => {
                resultsContainer.innerHTML += `<p>Team ${result.teamNumber}: ${result.totalScore}</p>`;
            });
        }

        window.onload = () => {
            promptForTeamNumber();
            document.getElementById("host-controls").style.display = hostMode ? 'block' : 'none';
            loadQuestion();
        };
    </script>
</head>
<body>
    <button id="host-toggle" onclick="toggleHostMode()">Toggle Host Mode</button>
    <h1>Quiz Application</h1>

    <!-- 班番号入力フォーム -->
    <div id="team-number-form" style="display: none;">
        <label for="team-number">Enter your team number:</label>
        <input type="text" id="team-number" required>
        <button onclick="saveTeamNumber()">Submit</button>
    </div>
    
    <!-- クイズのコンテンツ -->
    <div id="quiz-container" style="display: none;">
        <div id="question"></div>
        <div id="answer-container">
            <input type="text" id="answer-input" placeholder="Enter your answer">
            <button onclick="submitAnswer()">Submit Answer</button>
        </div>

        <div id="waiting-message" class="waiting-message" style="display: none;">
            Answer received! Please wait for the next question.
        </div>

        <div id="host-controls" style="display: none;">
            <button onclick="allowNextQuestion()">Next Question</button>
            <button onclick="displayResults()">Show Results</button>
            <button onclick="calculateFinalResults()">Show Final Results</button>
        </div>

        <div id="results"></div>
    </div>
</body>
</html>
