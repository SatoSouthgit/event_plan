<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Application</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        let hostMode = window.location.search.includes('host=true');
        let currentQuestionIndex = 0;
        let questions = [
            { question: "What is the capital of France?\nProvide the full name.", id: 1 },
            { question: "What is 2 + 2?\n(Hint: It is an even number)", id: 2 },
        ];
        let answers = {};
        let grades = {};

        // 入力された班番号を保存する
        function promptForTeamNumber() {
            let teamNumber = sessionStorage.getItem("teamNumber");
            if (!teamNumber) {
                teamNumber = prompt("Please enter your team number:");
                if (teamNumber) {
                    sessionStorage.setItem("teamNumber", teamNumber);
                } else {
                    alert("Team number is required to proceed.");
                    promptForTeamNumber();
                }
            }
        }

        function toggleHostMode() {
            hostMode = !hostMode;
            const url = new URL(window.location.href);
            if (hostMode) {
                url.searchParams.set('host', 'true');
            } else {
                url.searchParams.delete('host');
            }
            window.location.href = url.toString();
        }

        function loadQuestion() {
            const questionContainer = document.getElementById("question");
            const answerContainer = document.getElementById("answer-container");
            const waitingMessage = document.getElementById("waiting-message");

            if (currentQuestionIndex < questions.length) {
                questionContainer.innerHTML = questions[currentQuestionIndex].question.replace(/\n/g, '<br>');
                answerContainer.style.display = hostMode ? 'none' : 'block';  // Hide answer box in host mode
                waitingMessage.style.display = 'none';
            } else {
                questionContainer.textContent = "Quiz completed!";
                answerContainer.style.display = 'none';
                waitingMessage.style.display = 'none';
                if (hostMode) {
                    displayResults();
                }
            }
        }

        function submitAnswer() {
            const answer = document.getElementById("answer-input").value;
            const teamNumber = sessionStorage.getItem("teamNumber");

            if (!teamNumber) {
                alert("Team number is missing. Please refresh and enter your team number.");
                return;
            }

            if (!answer) {
                alert("Please enter an answer.");
                return;
            }

            answers[teamNumber] = answers[teamNumber] || [];
            answers[teamNumber].push({
                questionId: questions[currentQuestionIndex].id,
                answer: answer
            });

            saveAnswersToFirebase();

            document.getElementById("answer-input").value = "";
            document.getElementById("answer-container").style.display = 'none';
            document.getElementById("waiting-message").style.display = 'block';
        }

        function saveAnswersToFirebase() {
            const teamNumber = sessionStorage.getItem("teamNumber");
            firebase.database().ref('answers/' + teamNumber).set(answers[teamNumber]);
        }

        function allowNextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        function displayResults() {
            const resultsContainer = document.getElementById("results");
            resultsContainer.innerHTML = "<h2>Results</h2>";
            for (const [teamNumber, teamAnswers] of Object.entries(answers)) {
                resultsContainer.innerHTML += `<p>Team ${teamNumber}:<br>${teamAnswers.map(a => `Q${a.questionId}: ${a.answer}`).join('<br>')}</p>`;
                if (hostMode) {
                    displayGradingOptions(teamNumber, teamAnswers);
                }
            }
        }

        function displayGradingOptions(teamNumber, teamAnswers) {
            const resultsContainer = document.getElementById("results");
            teamAnswers.forEach((answer, index) => {
                const gradeOptions = Array.from({ length: 5 }, (_, i) => {
                    return `<option value="${i + 1}" ${grades[teamNumber] && grades[teamNumber][index] === i + 1 ? 'selected' : ''}>${i + 1}</option>`;
                }).join('');
                resultsContainer.innerHTML += `
                    <div>
                        <label>Grade for Q${answer.questionId}:</label>
                        <select class="grade-dropdown" onchange="saveGrade('${teamNumber}', ${index}, this.value)">
                            ${gradeOptions}
                        </select>
                    </div>`;
            });
        }

        function saveGrade(teamNumber, answerIndex, grade) {
            if (!grades[teamNumber]) grades[teamNumber] = [];
            grades[teamNumber][answerIndex] = parseInt(grade, 10);
            saveGradesToFirebase();
        }

        function saveGradesToFirebase() {
            firebase.database().ref('grades').set(grades);
        }

        function syncAnswers() {
            firebase.database().ref('answers').on('value', snapshot => {
                answers = snapshot.val() || {};
                displayResults();
            });
        }

        function calculateFinalResults() {
            const finalResults = [];
            for (const [teamNumber, teamAnswers] of Object.entries(answers)) {
                const totalScore = teamAnswers.reduce((sum, answer, index) => {
                    const grade = grades[teamNumber] && grades[teamNumber][index];
                    return sum + (grade || 0);
                }, 0);
                finalResults.push({ teamNumber, totalScore });
            }
            finalResults.sort((a, b) => b.totalScore - a.totalScore);
            displayFinalResults(finalResults);
        }

        function displayFinalResults(finalResults) {
            const resultsContainer = document.getElementById("results");
            resultsContainer.innerHTML = "<h2>Final Results</h2>";
            finalResults.forEach(result => {
                resultsContainer.innerHTML += `<p>Team ${result.teamNumber}: ${result.totalScore}</p>`;
            });
        }

        window.onload = () => {
            promptForTeamNumber();  // ここで班番号を最初に入力させる
            syncAnswers();
            document.getElementById("host-controls").style.display = hostMode ? 'block' : 'none';
            loadQuestion();
        };
    </script>
</head>
<body>
    <button id="host-toggle" onclick="toggleHostMode()">Toggle Host Mode</button>
    <h1>Quiz Application</h1>

    <div id="question"></div>

    <div id="answer-container">
        <input type="text" id="answer-input" placeholder="Enter your answer">
        <button onclick="submitAnswer()">Submit Answer</button>
    </div>

    <div id="waiting-message" class="waiting-message" style="display: none;">
        Answer received! Please wait for the next question.
    </div>

    <div id="host-controls" style="display: none;">
        <button onclick="allowNextQuestion()">Next Question</button>
        <button onclick="displayResults()">Show Results</button>
        <button onclick="calculateFinalResults()">Show Final Results</button>
    </div>

    <div id="results"></div>
</body>
</html>
